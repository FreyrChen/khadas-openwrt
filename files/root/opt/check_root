#!/bin/sh

## hyphop ##

#= check and prepare rootfs

echo "[i] check root fs"

ROOT=
for a in $(cat /proc/cmdline); do
    case $a in
    root=*)
    ROOT=${a#*=}
    ;;
    esac
done


[ "$ROOT" ] || {
    echo "[e] not root var in"
    exit 1
}

OFF=$(/opt/squashfs_size2 $ROOT 2>/dev/null)
echo "[i] squash root $ROOT offset + $OFF"

[ "$OFF" ] || {
    echo "[e] not found squash offset"
    exit 1
}

blkid -pD -O$OFF $ROOT || {
    echo "[i] not found root blkid"

    losetup

    LO=$(losetup -f -o$OFF $ROOT)
    [ "$LO" ] && {
	echo "[i] make ext4 overlay"
	mkfs.ext4 -Loverlay $LO
	losetup -d $LO
    }

    sleep 2

}


